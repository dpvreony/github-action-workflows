name: Common .NET setup and build workflow

on:
  workflow_call:
    inputs:
      solutionName:
        required: true
        type: string
        description: 'Name of the solution file WITHOUT the extension. On top of running the build. It is ued to calculate the format of the unit tests, benchmarks and integration tests.'
    secrets:
      NUGET_API_KEY:
        required: false
        description: 'API key used to release NUGET packages'
      SONAR_TOKEN:
        required: false
      SONAR_PROJECT_KEY:
        required: false
      SONAR_ORGANISATION_KEY:
        required: false
      VIRUSTOTAL_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false

jobs:
  build:
    uses: ./.github/workflows/_wfc_dotnet-ci-build.yml
    with:
      solutionName: ${{ inputs.solutionName }}

  licenses:
    uses: ./.github/workflows/_wfc_dotnet-ci-licenses.yml
    with:
      solutionName: ${{ inputs.solutionName }}

  snitch:
    uses: ./.github/workflows/_wfc_dotnet-ci-snitch.yml
    with:
      solutionName: ${{ inputs.solutionName }}

  appinspector:
    uses: ./.github/workflows/_wfc_dotnet-ci-appinspector.yml
    with:
      solutionName: ${{ inputs.solutionName }}

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v5
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: always

  validate-renovate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: dpvreony/github-action-renovate-config-validator@63c5f53df823879a6cd46a10d27fbe1d4ede7839

  omd-generation:
    uses: ./.github/workflows/_wfc_dotnet-ci-omd-generation.yml
    with:
      solutionName: ${{ inputs.solutionName }}

  vulnerable-nuget-packages:
    uses: ./.github/workflows/_wfc_dotnet-ci-vulnerable-nuget-packages.yml
    with:
      solutionName: ${{ inputs.solutionName }}

  deprecated-nuget-packages:
    uses: ./.github/workflows/_wfc_dotnet-ci-deprecated-nuget-packages.yml
    with:
      solutionName: ${{ inputs.solutionName }}

  check-nuget-api-key:
    runs-on: ubuntu-latest
    outputs:
      has_api_key: ${{ steps.check.outputs.has_api_key }}
    env:
      NUGET_API_KEY: ${{ secrets.nuget_api_key }}
    steps:
      - name: Check if NUGET_API_KEY is set
        id: check
        run: |
          if [ -n "$NUGET_API_KEY" ]; then
            echo "has_api_key=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_api_key=false" >> "$GITHUB_OUTPUT"
          fi
     
  check-nuget-environment:
    permissions:
      actions: read
      contents: read
      deployments: read
    runs-on: ubuntu-latest
    needs:
      check-nuget-api-key
    if: needs.check-nuget-api-key.outputs.has_api_key == 'true'
    steps:
      - name: Check if 'nuget' environment exists and has protection rules
        uses: dpvreony/ensure-environment-protected@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          environment_name: 'nuget'

  release:
    if: ${{ format('refs/heads/{0}', github.event.repository.default_branch) == github.ref }}
    permissions:
      contents: write
      pages: write
      id-token: write
    runs-on: ubuntu-latest
    needs: [build, check-nuget-environment]
    environment:
      name: nuget
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_NOLOGO: true
      DOTNET_GENERATE_ASPNET_CERTIFICATE: false
    steps:
    - name: Download NuGet Packages
      uses: actions/download-artifact@v5
      with:
        name: nuget
    - name: Create Release
      uses: actions/create-release@v1
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
      with:
          tag_name: ${{ needs.build.outputs.nbgv }}
          release_name: ${{ needs.build.outputs.nbgv }}
          body: |
            ${{ needs.build.outputs.change_commit_log }}

    - name: NuGet Push
      env:
        NUGET_AUTH_TOKEN: ${{ secrets.NUGET_API_KEY }}
        SOURCE_URL: https://api.nuget.org/v3/index.json
      run: |
        dotnet nuget push -s ${{ env.SOURCE_URL }} -k ${{ env.NUGET_AUTH_TOKEN }} **/*.nupkg
