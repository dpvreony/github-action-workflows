name: dotnet-build-linux

on:
  workflow_call:
    inputs:
      solutionName:
        required: true
        type: string
      isPrimaryBuildOs:
        required: false
        type: boolean
        default: true
        description: 'If true, this OS will upload release artifacts (nuget packages, SBOM, etc.)'
    secrets:
      SONAR_TOKEN:
        required: false
      SONAR_PROJECT_KEY:
        required: false
      SONAR_ORGANISATION_KEY:
        required: false
      VIRUSTOTAL_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false
    outputs:
      nbgv:
        description: 'NBGV SemVer2 version'
        value: ${{ jobs.build.outputs.nbgv }}
      change_commit_log:
        description: 'Change commit log'
        value: ${{ jobs.build.outputs.change_commit_log }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      nbgv: ${{ steps.nbgv.outputs.SemVer2 }}
      change_commit_log: ${{ steps.changelog.outputs.commitLog }}
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_NOLOGO: true
      DOTNET_GENERATE_ASPNET_CERTIFICATE: false
      solutionpath: ${{ inputs.solutionName }}.sln
      unittestprojectpath: ${{ inputs.solutionName }}.UnitTests/${{ inputs.solutionName }}.UnitTests.csproj
      inttestprojectpath: ${{ inputs.solutionName }}.IntegrationTests/${{ inputs.solutionName }}.IntegrationTests.csproj
      benchmarkprojectpath: ${{ inputs.solutionName }}.Benchmarks/${{ inputs.solutionName }}.Benchmarks.csproj
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
      - name: Setup Java 17
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Install .NET
        uses: actions/setup-dotnet@v5
        with:
          global-json-file: "./global.json"
      - name: Install DotNet workloads
        shell: bash
        run: |
          dotnet workload install android aspire ios tvos macos maui
          dotnet workload list
        working-directory: src
      - name: Cleanup nuget local storage
        run: |
          dotnet nuget locals all --clear
        working-directory: src
      - name: NBGV
        id: nbgv
        uses: dotnet/nbgv@master
        with:
          setAllVars: true
      - name: Install dotnet tools
        run: dotnet tool restore
        working-directory: src
      - name: Prepare Artifact Directory
        run: |
          mkdir -p artifacts/nupkg
          mkdir -p artifacts/outdated
          mkdir -p artifacts/sbom
          mkdir -p artifacts/binlog
      - name: Restore Packages
        run: |
          dotnet restore ${{ env.solutionpath }} /bl:${{ github.workspace }}/artifacts/binlog/restore.binlog
        working-directory: src
      - name: Changelog
        uses: glennawatson/ChangeLog@v1
        id: changelog
      - name: Report Changelog Summary
        run: |
          changecommitlog="${CHANGE_COMMIT_LOG}"
          changecommitlog="${changecommitlog//\"/\'}"
          echo "$changecommitlog" | while IFS= read -r line; do
            echo "::notice::$line"
            echo "$line" >> $GITHUB_STEP_SUMMARY
          done
        env:
          CHANGE_COMMIT_LOG: ${{ steps.changelog.outputs.commitLog }}
      - name: Run Sonar Scanner begin
        if: inputs.isPrimaryBuildOs && env.SONAR_TOKEN != '' && env.SONAR_PROJECT_KEY != '' && env.SONAR_ORGANISATION_KEY != ''
        run: |
          dotnet sonarscanner begin /k:"${{ env.SONAR_PROJECT_KEY }}" /d:sonar.login="${{ env.SONAR_TOKEN }}" /d:sonar.host.url="https://sonarcloud.io" /o:"${{ env.SONAR_ORGANISATION_KEY }}" /d:sonar.cs.opencover.reportsPaths="${{ github.workspace }}/artifacts/unittestcoverage/coverage.xml"
        working-directory: src
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORGANISATION_KEY: ${{ secrets.SONAR_ORGANISATION_KEY }}
      - name: Run Build
        id: run-build
        run: |
          dotnet build ${{ env.solutionpath }} --configuration Release --no-restore /bl:${{ github.workspace }}/artifacts/binlog/build.binlog /p:ContinuousIntegrationBuild=true
        working-directory: src
        env:
          CHANGE_COMMIT_LOG: ${{ steps.changelog.outputs.commitLog }}
      - name: Run Unit Tests
        working-directory: src
        run: |
          dotnet test ${{ env.unittestprojectpath }} --verbosity normal --configuration Release --no-build /bl:${{ github.workspace }}/artifacts/binlog/unittest.binlog --nologo --logger GitHubActions -- --coverage --coverage-output-format cobertura --coverage-output coverage.xml --long-running 10 --results-directory ${{ github.workspace }}/artifacts/unittestcoverage
      - name: Run Sonar Scanner end
        if: inputs.isPrimaryBuildOs && env.SONAR_TOKEN != '' && env.SONAR_PROJECT_KEY != '' && env.SONAR_ORGANISATION_KEY != ''
        run: |
          dotnet sonarscanner end /d:sonar.login="${{ env.SONAR_TOKEN }}"
        working-directory: src
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORGANISATION_KEY: ${{ secrets.SONAR_ORGANISATION_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Run BinLogStats for Build
        if: ${{ always() && !cancelled() && (steps.run-build.outcome == 'success' || steps.run-build.outcome == 'failure') }}
        run: |
          dotnet gripe-msbuildlogstats -bl ../artifacts/binlog/build.binlog
        working-directory: src
      - name: Upload Code Coverage
        run: |
          curl -Os https://uploader.codecov.io/latest/linux/codecov
          chmod +x codecov
          ./codecov -s 'artifacts/unittestcoverage' -f '*.xml' -v -t '${{ env.CODECOV_TOKEN }}'
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      - name: Report Unit Test Coverage
        run: |
          opencoverxmlpath=$(find artifacts/unittestcoverage/coverage.xml | head -n 1)
          if [ -f "$opencoverxmlpath" ]; then
            unitTestCoverage=$(grep -oP 'branchCoverage="\K[^"]*' "$opencoverxmlpath" | head -n 1)
            coverageMessage="Unit Test Coverage: $unitTestCoverage"
            echo "::notice::$coverageMessage"
            echo "$coverageMessage" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Run Integration Tests
        run: |
          dotnet test ${{ env.inttestprojectpath }} --configuration Release --no-build --nologo /bl:../artifacts/binlog/inttest.binlog --logger "GitHubActions;verbosity=normal" -- --coverage --coverage-output-format cobertura --coverage-output coverage.xml --long-running 10 --results-directory ${{ github.workspace }}/artifacts/inttestcoverage
        working-directory: src
      - name: Report Integration Test Coverage
        run: |
          opencoverxmlpath=$(find artifacts/inttestcoverage/coverage.xml | head -n 1)
          if [ -f "$opencoverxmlpath" ]; then
            intTestCoverage=$(grep -oP 'branchCoverage="\K[^"]*' "$opencoverxmlpath" | head -n 1)
            coverageMessage="Integration Test Coverage: $intTestCoverage"
            echo "::notice::$coverageMessage"
            echo "$coverageMessage" >> $GITHUB_STEP_SUMMARY
          fi
      - name: Produce Nuget Packages
        if: inputs.isPrimaryBuildOs
        run: |
          dotnet pack ${{ env.solutionpath }} --configuration Release --no-build /bl:${{ github.workspace }}/artifacts/binlog/pack.binlog --nologo /p:PackageOutputPath=${{ github.workspace }}/artifacts/nuget /p:ContinuousIntegrationBuild=true
        working-directory: src
        env:
          CHANGE_COMMIT_LOG: ${{ steps.changelog.outputs.commitLog }}
      - name: Generate SBOM
        if: inputs.isPrimaryBuildOs
        run: |
          dotnet sbom-tool generate -b artifacts/nuget -bc src -pn ${{ inputs.solutionName }} -pv $NBGV_SimpleVersion -ps "DHGMS Solutions" -nsb https://sbom.dhgms.com -m artifacts/sbom
      - name: List outdated packages
        if: inputs.isPrimaryBuildOs
        run: |
          dotnet outdated -o ${{ github.workspace }}/artifacts/outdated/outdated.json
        working-directory: src
      - name: VirusTotal Monitor Scan
        if: ${{ inputs.isPrimaryBuildOs && env.VIRUSTOTAL_API_KEY != '' }}
        uses: crazy-max/ghaction-virustotal@v4
        with:
          vt_api_key: ${{ env.VIRUSTOTAL_API_KEY }}
          vt_monitor: true
          monitor_path: /ghaction-virustotal
          files: |
            ./artifacts/nuget/*.nupkg
        env:
          VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
      - name: store binlogs
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: binlogs-linux
          path: artifacts/binlog
      - name: store unit test coverage
        if: ${{ inputs.isPrimaryBuildOs }}
        uses: actions/upload-artifact@v4
        with:
          name: unittestcoverage
          path: artifacts/unittestcoverage
          if-no-files-found: error
      - name: store integration test coverage
        if: ${{ inputs.isPrimaryBuildOs }}
        uses: actions/upload-artifact@v4
        with:
          name: inttestcoverage
          path: artifacts/inttestcoverage
      - name: store nuget packages
        if: inputs.isPrimaryBuildOs
        uses: actions/upload-artifact@v4
        with:
          name: nuget
          path: artifacts/nuget
          if-no-files-found: error
      - name: store omd
        if: inputs.isPrimaryBuildOs
        uses: actions/upload-artifact@v4
        with:
          name: omd
          path: artifacts/omd
      - name: store sbom
        if: inputs.isPrimaryBuildOs
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: artifacts/sbom
      - name: store outdated
        if: inputs.isPrimaryBuildOs
        uses: actions/upload-artifact@v4
        with:
          name: outdated
          path: artifacts/outdated
