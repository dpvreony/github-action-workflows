name: dotnet-build

on:
  workflow_call:
    inputs:
      solutionName:
        required: true
        type: string
      buildOs:
        required: false
        type: string
        default: 'linux'
        description: 'Primary OS for build and pack. Options: linux, windows. Default: linux'
      requiresMacOS:
        required: false
        type: boolean
        default: false
        description: 'If true, also builds and tests on macOS (never releases from macOS)'
    secrets:
      SONAR_TOKEN:
        required: false
      SONAR_PROJECT_KEY:
        required: false
      SONAR_ORGANISATION_KEY:
        required: false
      VIRUSTOTAL_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false
    outputs:
      nbgv:
        description: 'NBGV SemVer2 version'
        value: ${{ jobs.build-linux.outputs.nbgv || jobs.build-windows.outputs.nbgv }}
      change_commit_log:
        description: 'Change commit log'
        value: ${{ jobs.build-linux.outputs.change_commit_log || jobs.build-windows.outputs.change_commit_log }}

jobs:
  build-linux:
    if: inputs.buildOs == 'linux'
    uses: ./.github/workflows/_wfc_dotnet-ci-build-linux.yml
    with:
      solutionName: ${{ inputs.solutionName }}
      isPrimaryBuildOs: true
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORGANISATION_KEY: ${{ secrets.SONAR_ORGANISATION_KEY }}
      VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build-windows:
    if: inputs.buildOs == 'windows'
    uses: ./.github/workflows/_wfc_dotnet-ci-build-windows.yml
    with:
      solutionName: ${{ inputs.solutionName }}
      isPrimaryBuildOs: true
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORGANISATION_KEY: ${{ secrets.SONAR_ORGANISATION_KEY }}
      VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build-macos:
    if: inputs.requiresMacOS
    uses: ./.github/workflows/_wfc_dotnet-ci-build-macos.yml
    with:
      solutionName: ${{ inputs.solutionName }}
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
