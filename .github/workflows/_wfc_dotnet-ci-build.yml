name: dotnet-build

on:
  workflow_call:
    inputs:
      solutionName:
        required: true
        type: string
      useSlnx:
        required: false
        type: boolean
        default: false
        description: 'If true, uses .slnx solution format instead of .sln'
      buildOs:
        required: false
        type: string
        default: 'linux'
        description: 'Primary OS for build and pack. Valid values: "linux" or "windows". Default: "linux"'
      requiresMacOS:
        required: false
        type: boolean
        default: false
        description: 'If true, also builds and tests on macOS (never releases from macOS)'
      runIntTestsOnPrimaryOsOnly:
        required: false
        type: boolean
        default: false
        description: 'If true, integration tests will only run on the primary build OS'
    secrets:
      SONAR_TOKEN:
        required: false
      SONAR_PROJECT_KEY:
        required: false
      SONAR_ORGANISATION_KEY:
        required: false
      VIRUSTOTAL_API_KEY:
        required: false
      CODECOV_TOKEN:
        required: false
    outputs:
      nbgv:
        description: 'NBGV SemVer2 version'
        value: ${{ jobs.build-linux.outputs.nbgv || jobs.build-windows.outputs.nbgv }}
      change_commit_log:
        description: 'Change commit log'
        value: ${{ jobs.build-linux.outputs.change_commit_log || jobs.build-windows.outputs.change_commit_log }}

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Validate buildOs input
        run: |
          if [[ "${{ inputs.buildOs }}" != "linux" && "${{ inputs.buildOs }}" != "windows" ]]; then
            echo "::error::Invalid buildOs value '${{ inputs.buildOs }}'. Valid values are 'linux' or 'windows'."
            exit 1
          fi

  build-linux:
    needs: validate-inputs
    uses: ./.github/workflows/_wfc_dotnet-ci-build-linux.yml
    with:
      solutionName: ${{ inputs.solutionName }}
      useSlnx: ${{ inputs.useSlnx }}
      isPrimaryBuildOs: ${{ inputs.buildOs == 'linux' }}
      runIntTests: ${{ !inputs.runIntTestsOnPrimaryOsOnly || inputs.buildOs == 'linux' }}
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORGANISATION_KEY: ${{ secrets.SONAR_ORGANISATION_KEY }}
      VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build-windows:
    needs: validate-inputs
    if: inputs.buildOs == 'windows'
    uses: ./.github/workflows/_wfc_dotnet-ci-build-windows.yml
    with:
      solutionName: ${{ inputs.solutionName }}
      useSlnx: ${{ inputs.useSlnx }}
      isPrimaryBuildOs: true
      runIntTests: ${{ !inputs.runIntTestsOnPrimaryOsOnly || inputs.buildOs == 'windows' }}
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
      SONAR_ORGANISATION_KEY: ${{ secrets.SONAR_ORGANISATION_KEY }}
      VIRUSTOTAL_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  build-macos:
    needs: validate-inputs
    if: inputs.requiresMacOS
    uses: ./.github/workflows/_wfc_dotnet-ci-build-macos.yml
    with:
      solutionName: ${{ inputs.solutionName }}
      useSlnx: ${{ inputs.useSlnx }}
      runIntTests: ${{ !inputs.runIntTestsOnPrimaryOsOnly }}
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
