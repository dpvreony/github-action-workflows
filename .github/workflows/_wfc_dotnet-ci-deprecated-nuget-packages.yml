# name is made short because the check path becomes really long and repeditive
name: run

on:
  workflow_call:
    inputs:
      solutionName:
        required: true
        type: string
      useSlnx:
        required: false
        type: boolean
        default: false
        description: 'If true, uses .slnx solution format instead of .sln'
      workloads:
        required: false
        type: string
        default: ''
        description: 'Comma-separated list of .NET workloads to install'

jobs:
  nuget-depr-package-run:
    runs-on: windows-2025
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: 1
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
      DOTNET_NOLOGO: true
      DOTNET_GENERATE_ASPNET_CERTIFICATE: false
      solutionpath: ${{ inputs.solutionName }}.${{ inputs.useSlnx && 'slnx' || 'sln' }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v6.0.2
      with:
        path: a

    - name: Checkout dpvreony/github-action-workflow
      uses: actions/checkout@v6.0.2
      with:
        repository: dpvreony/github-action-workflows
        path: github-action-workflows

    - name: Install .NET
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: "a/global.json"

    - name: Install DotNet workloads
      uses: ./github-action-workflows/.github/actions/dotnet-install-workloads
      with:
        workloads: ${{ inputs.workloads }}

    - name: Prepare Artifact Directory
      run: |
        mkdir -p artifacts/nuget-deprecated

    - name: Restore Packages
      run: |
        dotnet restore ${{ env.solutionpath }} -- /bl:artifacts\binlog\restore.binlog
      working-directory: a/src

    - name: List vulnerable packages
      run: |
        dotnet list package --deprecated --format json --include-transitive >> ${{ github.workspace }}/artifacts/nuget-deprecated/output.json
      working-directory:
        a/src

    - name: store vulnerable package output
      if: ${{ always() }}
      uses: actions/upload-artifact@v7
      with:
        name: nuget-deprecated
        path: artifacts/nuget-deprecated
