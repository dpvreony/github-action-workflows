# name is made short because the check path becomes really long and repetitive
name: check-immutable-releases

on:
  workflow_call:
    outputs:
      immutable_releases_enabled:
        description: 'Whether immutable releases are enabled for the repository'
        value: ${{ jobs.check.outputs.immutable_releases_enabled }}

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      immutable_releases_enabled: ${{ steps.check.outputs.immutable_releases_enabled }}
    permissions:
      contents: read
    steps:
      - name: Check if immutable releases are enabled
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if immutable releases are enabled using GitHub API
          echo "Checking if immutable releases are enabled for ${{ github.repository }}..."
          
          # Use GitHub CLI to check immutable releases status
          if command -v gh &> /dev/null; then
            # Create temporary file and ensure cleanup on exit
            temp_response=$(mktemp)
            trap 'rm -f "$temp_response"' EXIT
            
            # Make API call and capture full response with headers
            if ! gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/immutable-releases \
              --include > "$temp_response" 2>&1; then
              echo "::error::Failed to call immutable releases API"
              # Show the error details from the API response
              if [ -s "$temp_response" ]; then
                echo "::error::API Error Details:"
                cat "$temp_response" | while IFS= read -r line; do
                  echo "::error::  $line"
                done
              fi
              echo "immutable_releases_enabled=false" >> "$GITHUB_OUTPUT"
              exit 1
            fi
            
            # Extract HTTP status code (look for HTTP/x.x or HTTP/x status line)
            http_status=$(grep -E "^HTTP/[0-9.]+ [0-9]+" "$temp_response" | tail -1 | awk '{print $2}')
            
            # Extract JSON body (everything after blank line that separates headers from body)
            json_body=$(awk '/^[[:space:]]*$/{flag=1; next} flag' "$temp_response")
            
            # Check for HTTP 200 response
            if [ "$http_status" != "200" ]; then
              echo "::error::Failed to query immutable releases API (HTTP ${http_status:-unknown})"
              # Show response body for debugging
              if [ -n "$json_body" ]; then
                echo "::error::Response body: $json_body"
              fi
              echo "immutable_releases_enabled=false" >> "$GITHUB_OUTPUT"
              exit 1
            fi
            
            # Extract the enabled field from JSON response
            immutable_status=$(echo "$json_body" | jq -r '.enabled' 2>/dev/null || echo "unknown")
            
            if [ "$immutable_status" == "true" ]; then
              echo "::notice::Immutable releases are enabled"
              echo "immutable_releases_enabled=true" >> "$GITHUB_OUTPUT"
              exit 0
            elif [ "$immutable_status" == "false" ]; then
              echo "::error::Immutable releases are NOT enabled"
              echo "::error::Immutable releases prevent modification of published releases (assets and tags)"
              echo "::error::This feature may require specific GitHub plan or organization settings"
              echo "immutable_releases_enabled=false" >> "$GITHUB_OUTPUT"
              exit 1
            else
              echo "::error::Could not determine immutable releases status (may not be available for this repository type)"
              echo "immutable_releases_enabled=false" >> "$GITHUB_OUTPUT"
              exit 1
            fi
          else
            echo "::error::GitHub CLI not available"
            echo "immutable_releases_enabled=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi
